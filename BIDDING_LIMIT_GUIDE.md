# 竞标限制功能使用指南

## 功能概述

为了防止用户重复参与同一个任务，系统现在实现了严格的竞标限制机制：

### 🔒 限制规则

1. **每个用户只能参与一次** - 同一个任务，每个用户只能参与一次竞标
2. **创建者不能参与** - 任务创建者不能参与自己发布的任务
3. **状态检查** - 只有处于"竞标中"状态的任务才能参与
4. **双重验证** - 前端和合约双重检查参与状态

### 🛡️ 安全检查机制

#### 前端检查
- 使用任务数据中的 `participants` 字段检查用户是否已参与
- 在竞标按钮显示时进行实时检查
- 提供清晰的禁用原因提示

#### 合约检查
- 在竞标前调用合约方法 `hasUserParticipated` 进行二次验证
- 获取最新的参与者列表确保数据准确性
- 防止并发竞标导致的重复参与

### 📋 实现细节

#### 1. 合约方法
```javascript
// 获取任务参与者列表
async getTaskParticipants(taskId)

// 检查用户是否已参与
async hasUserParticipated(taskId, userAddress)
```

#### 2. 前端检查逻辑
```javascript
// 检查用户是否可以参与任务
const canParticipate = (task) => {
  // 检查钱包连接
  // 检查是否为创建者
  // 检查任务状态
  // 检查是否已参与
}
```

#### 3. 竞标前双重检查
```javascript
// 在 quickBid 函数中
// 1. 前端检查
if (!canParticipate(task)) {
  alert(getDisabledReason(task))
  return
}

// 2. 合约检查
const hasParticipated = await web3Store.aptosContractService.hasUserParticipated(task.id, web3Store.account)
if (hasParticipated) {
  alert('您已经参与过此任务，不能重复参与')
  return
}
```

### 🎯 用户体验

#### 按钮状态
- **可参与**: 显示"立即竞标"按钮，绿色背景
- **已参与**: 显示"已参与"按钮，灰色背景，禁用状态
- **自己的任务**: 显示"自己的任务"按钮，灰色背景，禁用状态
- **不在竞标期**: 显示"不在竞标期"按钮，灰色背景，禁用状态

#### 提示信息
- 连接钱包: "请连接钱包"
- 自己的任务: "自己的任务"
- 不在竞标期: "不在竞标期"
- 已参与: "已参与"
- 重复参与: "您已经参与过此任务，不能重复参与"

### 🧪 测试方法

#### 1. 运行测试脚本
```javascript
// 在浏览器控制台运行
// 复制 test-bidding-limit.js 的内容并执行
```

#### 2. 手动测试步骤
1. 创建多个任务
2. 使用不同账户参与竞标
3. 尝试重复参与同一任务
4. 验证按钮状态和提示信息

#### 3. 测试场景
- ✅ 首次参与竞标 - 应该成功
- ❌ 重复参与竞标 - 应该被阻止
- ❌ 参与自己的任务 - 应该被阻止
- ❌ 参与非竞标期任务 - 应该被阻止

### 🔧 故障排除

#### 常见问题

1. **竞标按钮不显示**
   - 检查任务状态是否为1（竞标中）
   - 检查用户是否为任务创建者
   - 检查用户是否已参与

2. **重复参与成功**
   - 检查合约方法是否正常工作
   - 检查参与者数据是否正确更新
   - 检查前端状态同步

3. **按钮状态错误**
   - 刷新页面重新加载数据
   - 检查任务数据格式
   - 验证参与者地址格式

#### 调试方法

1. **查看控制台日志**
   - 检查参与状态检查的日志
   - 查看合约调用结果
   - 验证数据格式

2. **使用测试脚本**
   - 运行 `test-bidding-limit.js`
   - 检查所有任务的参与状态
   - 验证检查逻辑

3. **手动验证**
   - 在控制台手动调用检查方法
   - 验证参与者列表数据
   - 测试竞标功能

### 📝 更新日志

#### v1.0.0 (当前版本)
- ✅ 实现竞标限制功能
- ✅ 添加双重检查机制
- ✅ 优化用户体验
- ✅ 完善错误提示
- ✅ 添加测试脚本

### 🚀 未来改进

1. **实时更新** - 竞标成功后实时更新参与者列表
2. **缓存优化** - 优化参与者数据的缓存机制
3. **批量检查** - 支持批量检查多个任务的参与状态
4. **事件监听** - 添加竞标事件监听，自动更新状态

---

**注意**: 此功能确保每个用户只能参与一次竞标，有效防止重复参与和滥用行为。 