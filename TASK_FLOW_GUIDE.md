# 任务流程使用指南

## 概述

本项目已完善了完整的任务流程管理功能，包括竞标、选择中标者、提交任务验证、确认完成任务等主要流程。所有功能都基于Aptos Move智能合约实现，确保去中心化和安全性。

## 主要功能

### 1. 任务状态管理

任务有以下几种状态：
- **0 - 开放中**: 任务已创建，等待参与者竞标
- **1 - 进行中**: 已选择中标者，任务正在开发中
- **2 - 已完成**: 任务已完成并确认
- **3 - 争议中**: 任务出现争议，需要仲裁
- **4 - 已取消**: 任务被取消

### 2. 核心功能

#### 2.1 参与竞标
- **功能**: 用户参与任务竞标
- **权限**: 任何非任务创建者都可以参与
- **状态要求**: 任务状态必须为"开放中"
- **合约函数**: `participate_task(task_id: u64)`

#### 2.2 选择中标者
- **功能**: 任务创建者从参与者中选择中标者
- **权限**: 只有任务创建者可以调用
- **状态要求**: 任务状态必须为"开放中"
- **合约函数**: `select_winner(task_id: u64, winner: address)`

#### 2.3 提交任务完成
- **功能**: 中标者提交任务完成
- **权限**: 只有中标者可以调用
- **状态要求**: 任务状态必须为"进行中"
- **合约函数**: `complete_task(task_id: u64)`

#### 2.4 取消任务
- **功能**: 任务创建者取消任务
- **权限**: 只有任务创建者可以调用
- **状态要求**: 任务状态必须为"开放中"
- **合约函数**: `cancel_task(task_id: u64)`

## 前端界面

### 任务流程管理组件

在任务详情页面，新增了"任务流程管理"组件，提供以下功能：

#### 任务状态显示
- 显示当前任务状态
- 显示参与者数量
- 显示任务奖励
- 显示截止时间

#### 操作按钮
根据用户角色和任务状态，显示不同的操作按钮：

**任务创建者操作**:
- 选择中标者（任务开放中时）
- 取消任务（任务开放中时）
- 确认完成（任务进行中时）

**参与者操作**:
- 参与竞标（任务开放中时）
- 提交完成（中标者且任务进行中时）

**非参与者操作**:
- 参与竞标（任务开放中时）

#### 参与者列表
- 显示所有参与者
- 标识中标者
- 提供选择中标者的快捷按钮

## 使用流程

### 完整任务流程示例

1. **创建任务**
   ```
   任务创建者 → 创建任务 → 任务状态：开放中
   ```

2. **参与竞标**
   ```
   参与者 → 参与竞标 → 添加到参与者列表
   ```

3. **选择中标者**
   ```
   任务创建者 → 选择中标者 → 任务状态：进行中
   ```

4. **提交完成**
   ```
   中标者 → 提交任务完成 → 任务状态：已完成
   ```

### 异常流程

1. **取消任务**
   ```
   任务创建者 → 取消任务 → 任务状态：已取消
   ```

2. **争议处理**
   ```
   任何相关方 → 发起争议 → 任务状态：争议中
   ```

## 技术实现

### 智能合约

所有功能都在 `TaskFactory.move` 合约中实现：

```move
// 参与任务竞标
public entry fun participate_task(owner: &signer, task_id: u64)

// 选择中标者
public entry fun select_winner(owner: &signer, task_id: u64, winner: address)

// 完成任务
public entry fun complete_task(owner: &signer, task_id: u64)

// 取消任务
public entry fun cancel_task(owner: &signer, task_id: u64)
```

### 前端组件

- **TaskFlowManager.vue**: 主要的任务流程管理组件
- **AptosContractService.js**: 合约交互服务
- **TaskDetail.vue**: 任务详情页面（集成了流程管理）

### 状态管理

使用Vue 3的响应式系统和Pinia状态管理：
- 实时更新任务状态
- 自动刷新参与者列表
- 权限控制和UI状态同步

## 安全特性

### 权限控制
- 严格的权限检查，确保只有授权用户可以执行相应操作
- 基于钱包地址的身份验证
- 合约级别的权限验证

### 状态验证
- 确保操作只能在正确的任务状态下执行
- 防止重复操作和状态冲突
- 完整的错误处理和用户反馈

### 数据一致性
- 实时同步链上数据
- 自动刷新和状态更新
- 防止数据不一致问题

## 测试

### 测试脚本
运行 `test-complete-task-flow.js` 来测试完整流程：

```bash
node test-complete-task-flow.js
```

### 手动测试步骤
1. 创建新任务
2. 使用不同钱包参与竞标
3. 任务创建者选择中标者
4. 中标者提交任务完成
5. 验证任务状态变化

## 部署信息

- **合约地址**: `0xa1b3e0179d015222a7dfae11a029f96b173f0bf5b4747fd6c2d057dead2b921b`
- **网络**: Aptos Testnet
- **模块**: `TaskFactory`

## 故障排除

### 常见问题

1. **合约服务未初始化**
   - 确保钱包已连接
   - 刷新页面重新初始化

2. **权限不足**
   - 检查钱包地址是否正确
   - 确认用户角色和权限

3. **任务状态错误**
   - 检查任务当前状态
   - 确认操作是否符合状态要求

### 调试工具

- 使用浏览器控制台查看详细日志
- 检查网络请求和响应
- 验证合约调用参数

## 更新日志

### v1.0.0
- 完成基础任务流程功能
- 实现竞标、选择中标者、完成任务等核心功能
- 添加完整的前端界面和交互
- 集成Aptos Move智能合约
- 添加权限控制和状态管理
- 完善错误处理和用户反馈

## 联系方式

如有问题或建议，请通过以下方式联系：
- GitHub Issues
- 项目文档
- 技术支持邮箱 